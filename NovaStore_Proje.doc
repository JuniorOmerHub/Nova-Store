-- Proje: NovaStore E-Ticaret Veri Yönetim Sistemi
-- Tarih: 2026-01-24

-- 1. Veri Tabanı Kurulumu
IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'NovaStoreDB')
    CREATE DATABASE NovaStoreDB;
GO
USE NovaStoreDB;
GO

-- 2. Temizlik (Eski Tabloları ve Nesneleri Silme)
-- Constraint hatalarını önlemek için silme sırası önemlidir (Önce Child, Sonra Parent)
IF OBJECT_ID('dbo.trg_StockUpdate', 'TR') IS NOT NULL DROP TRIGGER dbo.trg_StockUpdate;
IF OBJECT_ID('dbo.sp_AddNewProduct', 'P') IS NOT NULL DROP PROCEDURE dbo.sp_AddNewProduct;
IF OBJECT_ID('dbo.vw_SiparisOzet', 'V') IS NOT NULL DROP VIEW dbo.vw_SiparisOzet;
IF OBJECT_ID('dbo.OrderDetails', 'U') IS NOT NULL DROP TABLE dbo.OrderDetails;
IF OBJECT_ID('dbo.Orders', 'U') IS NOT NULL DROP TABLE dbo.Orders;
IF OBJECT_ID('dbo.Products', 'U') IS NOT NULL DROP TABLE dbo.Products;
IF OBJECT_ID('dbo.Customers', 'U') IS NOT NULL DROP TABLE dbo.Customers;
IF OBJECT_ID('dbo.Categories', 'U') IS NOT NULL DROP TABLE dbo.Categories;
GO

-- 3. Tablo Tasarımı (DDL)
CREATE TABLE Categories (
    CategoryID INT IDENTITY(1,1) PRIMARY KEY,
    CategoryName NVARCHAR(50) NOT NULL
);

CREATE TABLE Products (
    ProductID INT IDENTITY(1,1) PRIMARY KEY,
    ProductName NVARCHAR(100) NOT NULL,
    Price DECIMAL(10,2) CHECK (Price > 0),
    Stock INT DEFAULT 0 CHECK (Stock >= 0),
    CategoryID INT FOREIGN KEY REFERENCES Categories(CategoryID)
);

CREATE TABLE Customers (
    CustomerID INT IDENTITY(1,1) PRIMARY KEY,
    FullName NVARCHAR(50),
    City NVARCHAR(20),
    Email NVARCHAR(100) UNIQUE
);

CREATE TABLE Orders (
    OrderID INT IDENTITY(1,1) PRIMARY KEY,
    CustomerID INT FOREIGN KEY REFERENCES Customers(CustomerID),
    OrderDate DATETIME DEFAULT GETDATE(),
    -- TotalAmount burada tutulabilir ancak tutarlılık için uygulama tarafında veya trigger ile yönetilmelidir.
    -- Bu örnekte manuel giriş yapılıyor.
    TotalAmount DECIMAL(10,2) DEFAULT 0 CHECK (TotalAmount >= 0)
);

CREATE TABLE OrderDetails (
    DetailID INT IDENTITY(1,1) PRIMARY KEY,
    OrderID INT FOREIGN KEY REFERENCES Orders(OrderID),
    ProductID INT FOREIGN KEY REFERENCES Products(ProductID),
    Quantity INT CHECK (Quantity > 0),
    -- KRİTİK DÜZELTME: Satış anındaki fiyatı saklamak için UnitPrice eklendi.
    UnitPrice DECIMAL(10,2) NOT NULL 
);
GO

-- 4. Veri Girişi (DML)
INSERT INTO Categories VALUES (N'Elektronik'), (N'Giyim'), (N'Kitap'), (N'Kozmetik'), (N'Ev ve Yaşam');

INSERT INTO Products (ProductName, Price, Stock, CategoryID) VALUES
(N'Laptop', 15000.00, 10, 1), 
(N'Akıllı Telefon', 8000.00, 25, 1), 
(N'Kablosuz Kulaklık', 1500.00, 50, 1),
(N'Kot Pantolon', 450.00, 100, 2), 
(N'Tişört', 150.00, 200, 2), 
(N'Spor Ayakkabı', 1200.00, 40, 2),
(N'Dünya Klasikleri Seti', 300.00, 15, 3), 
(N'Bilim Kurgu Romanı', 85.00, 60, 3),
(N'Ruj', 250.00, 80, 4), 
(N'Nemlendirici Krem', 350.00, 45, 4),
(N'Vazo', 120.00, 30, 5), 
(N'Kahve Makinesi', 2500.00, 12, 5);

INSERT INTO Customers (FullName, City, Email) VALUES
(N'Ahmet Yılmaz', N'İstanbul', N'ahmet.yilmaz@mail.com'), 
(N'Ayşe Demir', N'Ankara', N'ayse.demir@mail.com'),
(N'Mehmet Kaya', N'İzmir', N'mehmet.kaya@mail.com'), 
(N'Fatma Çelik', N'Bursa', N'fatma.celik@mail.com'),
(N'Ali Vural', N'Antalya', N'ali.vural@mail.com'), 
(N'Zeynep Şahin', N'İstanbul', N'zeynep.sahin@mail.com');

-- Sipariş Başlıkları
INSERT INTO Orders (CustomerID, OrderDate, TotalAmount) VALUES
(1, '2023-10-01', 16500.00), (2, '2023-10-05', 450.00), (3, '2023-10-10', 300.00),
(1, '2023-10-15', 350.00), (4, '2023-10-20', 2500.00), (5, '2023-10-25', 1350.00),
(2, '2023-11-01', 8000.00), (6, '2023-11-05', 600.00), (3, '2023-11-10', 170.00), (1, '2023-11-15', 15000.00);

-- Sipariş Detayları (UnitPrice manuel girildi, böylece fiyat geçmişi korunur)
INSERT INTO OrderDetails (OrderID, ProductID, Quantity, UnitPrice) VALUES
(1, 1, 1, 15000.00), (1, 3, 1, 1500.00), 
(2, 4, 1, 450.00), 
(3, 7, 1, 300.00), 
(4, 10, 1, 350.00), 
(5, 12, 1, 2500.00),
(6, 6, 1, 1200.00), (6, 5, 1, 150.00), 
(7, 2, 1, 8000.00), 
(8, 9, 2, 250.00), (8, 11, 1, 120.00), 
(9, 8, 2, 85.00), 
(10, 1, 1, 15000.00);
GO

-- 5. Trigger (Stok Güncelleme - GELİŞMİŞ VERSİYON)
IF OBJECT_ID('trg_StockUpdate', 'TR') IS NOT NULL DROP TRIGGER trg_StockUpdate;
GO
CREATE TRIGGER trg_StockUpdate ON OrderDetails AFTER INSERT AS
BEGIN
    SET NOCOUNT ON;
    
    -- Inserted tablosunu ProductID'ye göre gruplayarak stok düşer
    -- Bu yöntem, aynı insert içinde aynı ürün birden fazla satılırsa hatayı önler.
    UPDATE p 
    SET p.Stock = p.Stock - i.TotalQty
    FROM Products p 
    INNER JOIN (
        SELECT ProductID, SUM(Quantity) as TotalQty 
        FROM inserted 
        GROUP BY ProductID
    ) i ON p.ProductID = i.ProductID;
    
    -- Stok kontrolü (Opsiyonel: Eğer eksiye düşerse işlemi geri al)
    IF EXISTS (SELECT 1 FROM Products WHERE Stock < 0)
    BEGIN
        RAISERROR ('Stok yetersiz! İşlem iptal edildi.', 16, 1);
        ROLLBACK TRANSACTION;
    END
END;
GO

-- 6. Stored Procedure (Yeni Ürün Ekleme)
IF OBJECT_ID('sp_AddNewProduct', 'P') IS NOT NULL DROP PROCEDURE sp_AddNewProduct;
GO
CREATE PROCEDURE sp_AddNewProduct 
    @Name NVARCHAR(100), 
    @Price DECIMAL(10,2), 
    @Stock INT, 
    @CatID INT 
AS
BEGIN
    INSERT INTO Products (ProductName, Price, Stock, CategoryID)
    VALUES (@Name, @Price, @Stock, @CatID);
END;
GO

-- 7. View (Sipariş Özeti)
IF OBJECT_ID('dbo.vw_SiparisOzet', 'V') IS NOT NULL DROP VIEW dbo.vw_SiparisOzet;
GO
CREATE VIEW vw_SiparisOzet AS
SELECT 
    c.FullName, 
    o.OrderDate, 
    p.ProductName, 
    od.Quantity,
    od.UnitPrice AS SatisFiyati, -- O anki satış fiyatı
    (od.Quantity * od.UnitPrice) AS SatirToplami -- Dinamik hesaplama
FROM Customers c
JOIN Orders o ON c.CustomerID = o.CustomerID
JOIN OrderDetails od ON o.OrderID = od.OrderID
JOIN Products p ON od.ProductID = p.ProductID;
GO

-- 8. Örnek Sorgular (Test Etmek İçin)

-- Stok Durumu
SELECT ProductName, Stock FROM Products WHERE Stock < 20 ORDER BY Stock DESC;

-- Müşteri Bazlı Ciro (Doğru Hesaplama)
SELECT c.FullName, SUM(od.Quantity * od.UnitPrice) AS GercekToplamCiro 
FROM Customers c 
JOIN Orders o ON c.CustomerID = o.CustomerID
JOIN OrderDetails od ON o.OrderID = od.OrderID
GROUP BY c.FullName 
ORDER BY GercekToplamCiro DESC;

-- Ahmet Yılmaz'ın Aldığı Ürünler
SELECT p.ProductName, od.UnitPrice, cat.CategoryName 
FROM Customers c
JOIN Orders o ON c.CustomerID = o.CustomerID
JOIN OrderDetails od ON o.OrderID = od.OrderID
JOIN Products p ON od.ProductID = p.ProductID
JOIN Categories cat ON p.CategoryID = cat.CategoryID
WHERE c.FullName = N'Ahmet Yılmaz';
GO